<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>The TpSvc* interfaces</title>
<meta name="generator" content="DocBook XSL Stylesheets V1.75.2">
<link rel="home" href="index.html" title="telepathy-glib API Reference Manual">
<link rel="up" href="ch-service-dbus.html" title="Service-side D-Bus interfaces">
<link rel="prev" href="ch-service-dbus.html" title="Service-side D-Bus interfaces">
<link rel="next" href="telepathy-glib-svc-generic.html" title="Generic service-side interfaces">
<meta name="generator" content="GTK-Doc V1.15 (XML mode)">
<link rel="stylesheet" href="style.css" type="text/css">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table class="navigation" id="top" width="100%" summary="Navigation header" cellpadding="2" cellspacing="2"><tr valign="middle">
<td><a accesskey="p" href="ch-service-dbus.html"><img src="left.png" width="24" height="24" border="0" alt="Prev"></a></td>
<td><a accesskey="u" href="ch-service-dbus.html"><img src="up.png" width="24" height="24" border="0" alt="Up"></a></td>
<td><a accesskey="h" href="index.html"><img src="home.png" width="24" height="24" border="0" alt="Home"></a></td>
<th width="100%" align="center">telepathy-glib API Reference Manual</th>
<td><a accesskey="n" href="telepathy-glib-svc-generic.html"><img src="right.png" width="24" height="24" border="0" alt="Next"></a></td>
</tr></table>
<div class="refentry" title="The TpSvc* interfaces">
<a name="telepathy-glib-svc"></a><div class="titlepage"></div>
<div class="refnamediv"><table width="100%"><tr>
<td valign="top">
<h2><span class="refentrytitle">
      The TpSvc* interfaces
    </span></h2>
<p>The TpSvc* interfaces â€” How to export Telepathy objects</p>
</td>
<td valign="top" align="right"></td>
</tr></table></div>
<p>
    The GInterfaces whose names start with TpSvc are generated automatically
    from the Telepathy specification, and can be used to make it easier
    to export methods and signals onto D-Bus. By implementing these
    GInterfaces you can avoid needing to generate any "glue" using the
    dbus-glib tools - this is all done internally inside telepathy-glib.
  </p>
<p>
    The media session interface makes a convenient example
    because it only has two methods (Error() and Ready())
    and one signal (NewStreamHandler), and media session handlers
    aren't expected to implement any other interfaces.
  </p>
<p>
    The first thing to do is pre-declare the interface init function,
    and define the type you'll be using, declaring it to implement the
    media stream handler interface:
  </p>
<div class="informalexample">
  <table class="listing_frame" border="0" cellpadding="0" cellspacing="0">
    <tbody>
      <tr>
        <td class="listing_lines" align="right"><pre>1</pre></td>
        <td class="listing_code"><pre class="programlisting"></pre></td>
      </tr>
    </tbody>
  </table>
</div>

<p>
    Here we're using a subclass of G_TYPE_OBJECT. You can of course subclass
    any type.
  </p>
<p>
    If you're implementing more than one interface on the same object,
    define more than one init function, and call G_IMPLEMENT_INTERFACE
    more than once. The interface init functions can even be extern
    if you want to separate off chunks of functionality into a different
    .c file. For instance, here's GabbleConnection:
  </p>
<div class="informalexample">
  <table class="listing_frame" border="0" cellpadding="0" cellspacing="0">
    <tbody>
      <tr>
        <td class="listing_lines" align="right"><pre>1</pre></td>
        <td class="listing_code"><pre class="programlisting"></pre></td>
      </tr>
    </tbody>
  </table>
</div>

<p>
    The _class_init, _init etc. functions are just like normal, so I
    won't describe them here. One thing to note, though, is that for
    signals which are defined by the GInterface, you do not need to do
    anything in the _class_init - the GInterface has already set the
    signal up for you.
  </p>
<p>
    For each exported D-Bus method, there's a typedef ending with _impl
    giving the signature you should use for your method implementation.
    For example, here's the signature for the Error method on the
    media session handler interface:
    </p>
<div class="informalexample">
  <table class="listing_frame" border="0" cellpadding="0" cellspacing="0">
    <tbody>
      <tr>
        <td class="listing_lines" align="right"><pre>1</pre></td>
        <td class="listing_code"><pre class="programlisting"></pre></td>
      </tr>
    </tbody>
  </table>
</div>

<p>
    and here's the beginning of the corresponding implementation:
    </p>
<div class="informalexample">
  <table class="listing_frame" border="0" cellpadding="0" cellspacing="0">
    <tbody>
      <tr>
        <td class="listing_lines" align="right"><pre>1</pre></td>
        <td class="listing_code"><pre class="programlisting"></pre></td>
      </tr>
    </tbody>
  </table>
</div>

<p>
    All service methods in telepathy-glib are asynchronous - you can of
    course implement them synchronously if you like, but you have to return
    the result or error to D-Bus by calling a callback rather than by
    returning from a function.
  </p>
<p>
    The method implementation's last parameter is a DBusGMethodInvocation.
    To send the reply, you must either call dbus_g_method_return_error
    (for a failure), dbus_g_method_return (for a successful return),
    or an inline function whose name contains "_return_from_" provided by
    the TpSvc interface. For example, for Error there's an inline function
    tp_svc_media_session_handler_return_from_error(). These inline functions
    are just a simple wrapper around dbus_g_method_return() to make it
    type-safe - it's recommended that you use them where possible.
  </p>
<p>
    For instance, Error doesn't return anything, so
    tp_svc_media_session_handler_return_from_error() doesn't take any
    parameters apart from the DBusGMethodInvocation:
    </p>
<div class="informalexample">
  <table class="listing_frame" border="0" cellpadding="0" cellspacing="0">
    <tbody>
      <tr>
        <td class="listing_lines" align="right"><pre>1</pre></td>
        <td class="listing_code"><pre class="programlisting"></pre></td>
      </tr>
    </tbody>
  </table>
</div>

<p>
  </p>
<p>
    As for signals, they're named as dictated by dbus-glib. This normally
    gives you a sensible lower-case name - for instance NewStreamHandler
    is mapped to "new-stream-handler".
  </p>
<p>
    To emit a signal, the generated code contains another convenience
    function whose name contains _emit_. This is prototyped to take
    the correct arguments for the signal, and emits it efficiently:
    </p>
<div class="informalexample">
  <table class="listing_frame" border="0" cellpadding="0" cellspacing="0">
    <tbody>
      <tr>
        <td class="listing_lines" align="right"><pre>1</pre></td>
        <td class="listing_code"><pre class="programlisting"></pre></td>
      </tr>
    </tbody>
  </table>
</div>

<p>
  </p>
<p>
    Finally, the interface init function needs to be written. Normally
    you'd set the fields of a vtable to be pointers to your method
    implementations. However, we couldn't do this in telepathy-glib
    because that would mean breaking the ABI every time we added methods
    to an interface. Instead, you call functions, with pointers to your
    method implementations as a parameter:
    </p>
<div class="informalexample">
  <table class="listing_frame" border="0" cellpadding="0" cellspacing="0">
    <tbody>
      <tr>
        <td class="listing_lines" align="right"><pre>1</pre></td>
        <td class="listing_code"><pre class="programlisting"></pre></td>
      </tr>
    </tbody>
  </table>
</div>

<p>
    This is obviously quite repetitive if there are a lot of methods, so
    the convention I've used in telepathy-glib, Gabble and
    telepathy-sofiasip is to define a temporary macro called IMPLEMENT:
    </p>
<div class="informalexample">
  <table class="listing_frame" border="0" cellpadding="0" cellspacing="0">
    <tbody>
      <tr>
        <td class="listing_lines" align="right"><pre>1</pre></td>
        <td class="listing_code"><pre class="programlisting"></pre></td>
      </tr>
    </tbody>
  </table>
</div>

<p>
  </p>
<p>
    If you're implementing many interfaces, just write many similar
    interface init functions.
  </p>
</div>
<div class="footer">
<hr>
          Generated by GTK-Doc V1.15</div>
</body>
</html>